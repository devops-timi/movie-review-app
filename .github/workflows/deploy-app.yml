name: Deploy Application
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Write SSH key to disk
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/connect.pem
          chmod 600 ~/.ssh/connect.pem

      - name: Add SSH key to agent
        run: |
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/connect.pem
          echo "SSH_AUTH_SOCK=${SSH_AUTH_SOCK}" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=${SSH_AGENT_PID}" >> $GITHUB_ENV

      - name: Get runner public IP
        id: ip
        run: echo "runner_ip=$(curl -s ifconfig.me)/32" >> $GITHUB_OUTPUT

      - name: Add runner IP to web SG
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.WEB_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.runner_ip }}

      - name: Configure web instances
        run: |
          WEB_IPS=$(echo '${{ secrets.WEB_INSTANCE_IPS }}' | jq -r '.[]')
          INTERNAL_CLB="${{ secrets.INTERNAL_CLB_DNS }}"
          REPO="https://github.com/${{ github.repository }}.git"

          WEB_SCRIPT='
            set -e
            sudo apt update -y
            sudo apt install -y git nginx curl
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            sudo npm install -g pm2
            if [ ! -d /app ]; then
              sudo git clone '"$REPO"' /app
            else
              cd /app && sudo git pull origin main
            fi
            sudo cp /app/nginx/nginx.conf /etc/nginx/sites-available/movie-review
            sudo sed -i "s|INTERNAL_CLB_PLACEHOLDER|'"$INTERNAL_CLB"'|g" /etc/nginx/sites-available/movie-review
            sudo ln -sf /etc/nginx/sites-available/movie-review /etc/nginx/sites-enabled/movie-review
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl enable nginx
            sudo systemctl restart nginx
            cd /app/frontend
            sudo npm install
            sudo npm run build
            pm2 delete frontend 2>/dev/null || true
            pm2 start /app/frontend/.next/standalone/server.js --name frontend
            pm2 logs frontend --lines 20
          '

          for HOST in $WEB_IPS; do
            ssh -o StrictHostKeyChecking=no ubuntu@$HOST bash -s <<< "$WEB_SCRIPT"
          done

      - name: Configure app instances
        run: |
          WEB_IP=$(echo '${{ secrets.WEB_INSTANCE_IPS }}' | jq -r '.[0]')
          APP_IPS=$(echo '${{ secrets.APP_INSTANCE_IPS }}' | jq -r '.[]')
          REPO="https://github.com/${{ github.repository }}.git"
          DB_HOST="${{ secrets.DB_HOST }}"
          DB_USER="${{ secrets.DB_USERNAME }}"
          DB_PASS="${{ secrets.DB_PASSWORD }}"
          PUBLIC_CLB="${{ secrets.PUBLIC_CLB_DNS }}"

          APP_SCRIPT='
            set -e
            sudo apt update -y
            sudo apt install -y git curl mysql-client
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            sudo npm install -g pm2
            if [ ! -d /app ]; then
              sudo git clone '"$REPO"' /app
            else
              cd /app && sudo git pull origin main
            fi
            printf "PORT=3010\nNODE_ENV=production\nDB_HOST='"$DB_HOST"'\nDB_PORT=3306\nDB_USER='"$DB_USER"'\nDB_PASSWORD='"$DB_PASS"'\nDB_NAME=movie_reviews\nCORS_ORIGIN=http://'"$PUBLIC_CLB"'\n" | sudo tee /app/backend/.env > /dev/null
            mysql --force -h '"$DB_HOST"' -u '"$DB_USER"' -p'"$DB_PASS"' movie_reviews < /app/database/schema.sql
            mysql --force -h '"$DB_HOST"' -u '"$DB_USER"' -p'"$DB_PASS"' movie_reviews < /app/database/seed.sql
            cd /app/backend
            sudo npm install --omit=dev
            pm2 delete backend 2>/dev/null || true
            pm2 start src/server.js --name backend
          '

          for APP in $APP_IPS; do
            ssh -o StrictHostKeyChecking=no \
                -o ProxyJump=ubuntu@$WEB_IP \
                ubuntu@$APP bash -s <<< "$APP_SCRIPT"
          done

      - name: Remove runner IP from web SG
        if: always() && steps.ip.outputs.runner_ip != ''
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.WEB_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.runner_ip }}