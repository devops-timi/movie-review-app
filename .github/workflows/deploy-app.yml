name: Deploy Application
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install jq
        run: sudo apt install -y jq

      - name: Write SSH key to disk
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/connect.pem
          chmod 600 ~/.ssh/connect.pem

      - name: Add SSH key to agent
        run: |
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/connect.pem
          echo "SSH_AUTH_SOCK=${SSH_AUTH_SOCK}" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=${SSH_AGENT_PID}" >> $GITHUB_ENV

      - name: Get runner public IP
        id: ip
        run: echo "runner_ip=$(curl -s ifconfig.me)/32" >> $GITHUB_OUTPUT

      - name: Add runner IP to web SG
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.WEB_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.runner_ip }}

      - name: Configure web instances
        run: |
          WEB_IPS=$(echo '${{ secrets.WEB_INSTANCE_IPS }}' | jq -r '.[]')

          for HOST in $WEB_IPS; do
            ssh -o StrictHostKeyChecking=no ubuntu@$HOST bash << EOF
              set -e

              # Install packages
              sudo apt update -y
              sudo apt install -y git nginx curl

              # Install Node.js 20
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt install -y nodejs

              # Install pm2
              sudo npm install -g pm2

              # Clone or update repo
              if [ ! -d "/app" ]; then
                sudo git clone https://github.com/${{ github.repository }}.git /app
              else
                cd /app && sudo git pull origin main
              fi

              # Configure nginx
              sudo cp /app/nginx/nginx.conf /etc/nginx/sites-available/movie-review
              sudo sed -i "s|INTERNAL_CLB_PLACEHOLDER|${{ secrets.INTERNAL_CLB_DNS }}|g" /etc/nginx/sites-available/movie-review
              sudo ln -sf /etc/nginx/sites-available/movie-review /etc/nginx/sites-enabled/movie-review
              sudo rm -f /etc/nginx/sites-enabled/default
              sudo nginx -t
              sudo systemctl enable nginx
              sudo systemctl restart nginx

              # Install and build frontend
              cd /app/frontend
              sudo npm install
              sudo npm run build

              # Start frontend
              pm2 delete frontend 2>/dev/null || true
              pm2 start npm --name frontend -- start
            EOF
          

      - name: Configure app instances
        run: |
          WEB_IP=$(echo '${{ secrets.WEB_INSTANCE_IPS }}' | jq -r '.[0]')
          APP_IPS=$(echo '${{ secrets.APP_INSTANCE_IPS }}' | jq -r '.[]')

          for APP in $APP_IPS; do
            ssh -o StrictHostKeyChecking=no \
                -o ProxyJump=ubuntu@$WEB_IP \
                ubuntu@$APP bash << EOF
              set -e

              # Install packages
              sudo apt update -y
              sudo apt install -y git curl mysql-client

              # Install Node.js 20
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt install -y nodejs

              # Install pm2
              sudo npm install -g pm2

              # Clone or update repo
              if [ ! -d "/app" ]; then
                sudo git clone https://github.com/${{ github.repository }}.git /app
              else
                cd /app && sudo git pull origin main
              fi

              # Write .env file
              sudo tee /app/backend/.env > /dev/null << ENVEOF
                PORT=3010
                NODE_ENV=production
                DB_HOST=${{ secrets.DB_HOST }}
                DB_PORT=3306
                DB_USER=${{ secrets.DB_USERNAME }}
                DB_PASSWORD=${{ secrets.DB_PASSWORD }}
                DB_NAME=movie_reviews
                CORS_ORIGIN=http://${{ secrets.PUBLIC_CLB_DNS }}
              ENVEOF

              # Import database
              mysql --force \
                -h ${{ secrets.DB_HOST }} \
                -u ${{ secrets.DB_USERNAME }} \
                -p${{ secrets.DB_PASSWORD }} \
                movie_reviews < /app/database/schema.sql

              mysql --force \
                -h ${{ secrets.DB_HOST }} \
                -u ${{ secrets.DB_USERNAME }} \
                -p${{ secrets.DB_PASSWORD }} \
                movie_reviews < /app/database/seed.sql

              # Install backend dependencies
              cd /app/backend
              sudo npm install --omit=dev

              # Start backend
              pm2 delete backend 2>/dev/null || true
              pm2 start src/server.js --name backend
            EOF
          done

      - name: Remove runner IP from web SG
        if: always() && steps.ip.outputs.runner_ip != ''
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.WEB_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.runner_ip }}