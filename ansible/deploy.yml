---

# ─────────────────────────────────────────────
# WEB TIER
# ─────────────────────────────────────────────
- name: Configure Web Tier
  hosts: web
  become: yes

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600  # Optional: skip if updated in the last hour
    
    - name: Install required packages
      apt:
        name:
          - nginx
          - unzip       # needed for awscli zip
          - curl   
          - git     # needed to download awscli
        state: present

    - name: Install AWS CLI v2 if not present
      shell: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        ./aws/install
        rm -rf awscliv2.zip aws
        aws --version
      args:
        creates: /usr/local/bin/aws

    - name: Install Node.js 20
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        apt install -y nodejs
      args:
        creates: /usr/bin/node

    - name: Clone repository
      git:
        repo: "{{ repo_url }}"
        dest: /app
        version: main
        force: yes
      # Clones your GitHub repo into /app on the web instance
      # force: yes means if /app already exists it will update it
      # version: main means the main branch
      # repo_url comes from group_vars/all.yml
    
    - name: Ensure Nginx is started and enabled
      systemd:
        name: nginx
        state: started
        enabled: yes
    
    - name: Reset connection to apply group changes
      ansible.builtin.meta: reset_connection

    - name: Update nginx upstream with internal CLB DNS
      replace:
        path: /app/nginx/nginx.conf
        regexp: 'server 127.0.0.1:3010'
        replace: 'server {{ internal_clb_dns }}:3010'

    - name: Copy nginx config from cloned repo
      copy:
        src: /app/nginx/nginx.conf
        dest: /etc/nginx/sites-available/movie-review
        remote_src: yes
        owner: root
        group: root
        mode: '0644'
      # remote_src: yes means the src path is on the remote instance
      # not on your laptop or the runner
      # It copies from /app/nginx/nginx.conf (cloned from repo)
      # to where nginx expects it
      notify: restart nginx
      
    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/movie-review
        dest: /etc/nginx/sites-enabled/movie-review
        state: link
      notify: restart nginx

    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx
      
    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      changed_when: false

    # ── Send SQL files to app instance ───────────
    # Web instance cloned the repo so it has the SQL files
    # App instance has no internet so it can't clone itself
    # We SCP just the two SQL files across the internal network

    - name: Copy SSH key to web instance
      copy:
        content: "{{ ssh_private_key }}"
        dest: /home/ubuntu/.ssh/connect.pem
        owner: ubuntu
        mode: '0600'
      # ssh_private_key comes from group_vars/all.yml
      # which reads it from the environment (GitHub secret)
      # mode 0600 = only owner can read — required by SSH

      # Copies directly from the cloned repo on the web instance
      # to the app instance over the internal VPC network
      # No internet involved at all

    
      # Web instance pulls the backend image since it has internet

  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
      listen: restart nginx

# ─────────────────────────────────────────────
# APP TIER
# Reached via ProxyJump through web instance
# ─────────────────────────────────────────────
- name: Configure app tier
  hosts: app
  become: true

  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Docker and MySQL
      apt:
        name:
          - mysql-client
          - git
          - curl
        state: present

    - name: Install Node.js 20
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        apt install -y nodejs
      args:
        creates: /usr/bin/node

    - name: Reset connection to apply group changes
      ansible.builtin.meta: reset_connection
    
    - name: Clean up cloned repo
      file:
        path: /app
        state: absent
# ─────────────────────────────────────────────
# DATABASE
# Runs from the app instance → RDS
# SQL files were SCP'd here from the web instance
# ─────────────────────────────────────────────
- name: Import database
  hosts: app[0]
  become: true

  tasks:

    - name: Clone repository for SQL files
      git:
        repo: "{{ repo_url }}"
        dest: /app
        version: main
        force: yes

    - name: Import schema into RDS
      shell: |
        mysql --force \
              -h {{ db_host }} \
              -P {{ db_port }} \
              -u {{ db_user }} \
              -p{{ db_password }} \
              {{ db_name }} < /app/database/schema.sql

      # Runs ON the app instance
      # App instance SG is allowed through DB SG on port 3306
      # mysql reads each line of schema.sql and executes it against RDS

    - name: Import seed data into RDS
      shell: |
        mysql --force \
              -h {{ db_host }} \
              -P {{ db_port }} \
              -u {{ db_user }} \
              -p{{ db_password }} \
              {{ db_name }} < /app/database/seed.sql

    - name: Clean up
      file:
        path: /app
        state: absent