---

# ─────────────────────────────────────────────
# WEB TIER
# ─────────────────────────────────────────────
- name: Configure Web Tier
  hosts: web
  become: yes

  tasks:
    
    - name: Update and Install required packages
      apt:
        update_cache: yes
        name:
          - nginx
          - unzip       # needed for awscli zip
          - curl   
          - git     # needed to download awscli
        state: present

    - name: Install Node.js 20
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        apt install -y nodejs
      args:
        creates: /usr/bin/node

    - name: Clone repository
      git:
        repo: "{{ repo_url }}"
        dest: /app
        version: main
        force: yes
      # Clones your GitHub repo into /app on the web instance
      # force: yes means if /app already exists it will update it
      # version: main means the main branch
      # repo_url comes from group_vars/all.yml
    
    - name: Render Nginx config from template
      template:
        src: "{{ playbook_dir }}/../nginx/nginx.conf.template"
        dest: /etc/nginx/sites-available/movie-review
        owner: root
        group: root
        mode: '0644'
        remote_src: yes
      notify: restart nginx

    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/movie-review
        dest: /etc/nginx/sites-enabled/movie-review
        state: link
      notify: restart nginx

    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Ensure Nginx is started and enabled
      systemd:
        name: nginx
        state: started
        enabled: yes    

    - name: Install frontend dependencies
      shell: |
        cd /app/frontend && npm install

    - name: Build frontend
      shell: |
        cd /app/frontend && npm run build

    - name: Install pm2
      shell: npm install -g pm2
      args:
        creates: /usr/bin/pm2

    - name: Start frontend with pm2
      shell: |
        pm2 delete frontend 2>/dev/null || true
        cd /app/frontend && pm2 start npm --name frontend -- start
      
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
      listen: restart nginx

# ─────────────────────────────────────────────
# APP TIER
# Reached via ProxyJump through web instance
# ─────────────────────────────────────────────
- name: Configure app tier
  hosts: app
  become: true

  tasks:
        
    - name: Install MySQL
      apt:
        update_cache: yes
        name:
          - mysql-client
          - git
          - curl
        state: present

    - name: Install Node.js 20
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        apt install -y nodejs
      args:
        creates: /usr/bin/node

    - name: Clone repository
      git:
        repo: "{{ repo_url }}"
        dest: /app
        version: main
        force: yes

    - name: Install backend dependencies
      shell: cd /app/backend && npm install --omit=dev
      

    - name: Install pm2
      shell: npm install -g pm2
      args:
        creates: /usr/bin/pm2

    - name: Create backend .env
      copy:
        dest: /app/backend/.env
        content: |
          PORT=3010
          NODE_ENV=production
          DB_HOST={{ db_host }}
          DB_PORT=3306
          DB_USER={{ db_user }}
          DB_PASSWORD={{ db_password }}
          DB_NAME=movie_reviews
          CORS_ORIGIN=http://{{ public_clb_dns }}
        owner: ubuntu
        group: ubuntu
        mode: '0600'
      
# ─────────────────────────────────────────────
# DATABASE
# Runs from th /app instance → RDS
# SQL files were SCP'd here from the web instance
# ─────────────────────────────────────────────

    - name: Import schema into RDS
      shell: |
        mysql --force \
              -h {{ db_host }} \
              -P {{ db_port }} \
              -u {{ db_user }} \
              -p{{ db_password }} \
              {{ db_name }} < /app/database/schema.sql

      # Runs ON the /app instance
      # App instance SG is allowed through DB SG on port 3306
      # mysql reads each line of schema.sql and executes it against RDS

    - name: Import seed data into RDS
      shell: |
        mysql --force \
              -h {{ db_host }} \
              -P {{ db_port }} \
              -u {{ db_user }} \
              -p{{ db_password }} \
              {{ db_name }} < /app/database/seed.sql

    - name: Start backend with pm2
      shell: |
        pm2 delete backend 2>/dev/null || true
        cd /app/backend && pm2 start src/server.js --name backend
      args:
        chdir: /app/backend
      
